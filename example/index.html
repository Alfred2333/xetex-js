<html>
  <head>
    <script src="../workercontroller.umd.js"></script>
    <script>
      /* global workercontroller */
      var controller = new workercontroller.XeLaTeXController(
        '../xetex.worker.js');
      controller.xelatexFmtUrl = '../xelatex.fmt';
      controller.texLiveManifestUrl = '../texlive.lst';

      // Setup virtual filesystem and return a promise. We need to call this
      // function every time the xetex image reloads, since the filesystem
      // defaults to an in-memory filesystem with no persistence.
      var doReload = function() {
        console.log('Reloading...');
        return controller.reload().then(stats => {
          console.log('Loaded.', stats);
        });
      };

      // Prepare the FS either when the program is ready again or when the user
      // requests compile
      var autoReload = false;
      var reloaded = doReload();

      document.addEventListener('DOMContentLoaded', function() {
        var autoReloadCheckbox = document.getElementById('auto-reload');
        autoReloadCheckbox.addEventListener('change', function() {
          autoReload = this.value;
        });

        var form = document.getElementById('form');
        var sourceTextArea = document.getElementById('source');
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          var doCompile = function() {
            console.log('Performing compilation...');
            controller.createDataFile('/', 'source.tex', sourceTextArea.value,
                                      false, true)
                      .then(function(result) {
                        console.log('source textarea: FS.createDataFile', result);
                      }, function(error) {
                        console.log('source textarea: FS.createDataFile', error);
                      });
            controller.sendMessage({
              namespace: 'Module', command: 'callMain',
              // uncomment below to debug kpathsea search paths
              // arguments: [['-kpathsea-debug=-1', '-interaction=nonstopmode', 'source.tex']]
              arguments: [['-interaction=nonstopmode', 'source.tex']]
            }).then(function(result) {
              console.log('compile: Module.callMain', result);
            }, function(error) {
              console.error('compile: Module.callMain', error);
            }).then(function() {
              if (autoReload) {
                reloaded = doReload();
              } else {
                reloaded = null;
              }
            });
          };
          if (!reloaded) {
            reloaded = doReload();
          }
          reloaded.then(doCompile);
        });
      });
    </script>
  </head>
  <body>
    <form id="form">
      <label for="auto-reload">Immediately reload the program image and filesystem after program exit</label>
      <input id="auto-reload" type="checkbox">
      <label for="source">Source</label>
      <textarea id="source"></textarea>
      <input type="submit" value="Compile">
    </form>

  </body>
</html>
